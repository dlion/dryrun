<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <title>{% if page.title %}{{ page.title }} · {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
    <meta name="description" content="{{ page.description | default: site.description | strip_newlines }}">

    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/syntax.css' | relative_url }}">

    {% seo %}
  </head>
  <body>
    {% include header.html %}

    <main class="container">
      {{ content }}
    </main>

    <footer class="site-footer">
      <div class="container">
        <div>© {{ site.time | date: '%Y' }} {{ site.author | default: site.title }} · <a href="{{ '/feed.xml' | relative_url }}">RSS</a></div>
        <div class="links">
          {% for link in site.links %}
            <a href="{{ link.url }}">{{ link.label }}</a>{% unless forloop.last %} · {% endunless %}
          {% endfor %}
        </div>
      </div>
    </footer>

    <script>
    (function () {
      const root = document.documentElement;
      const key = 'theme';
      const stored = localStorage.getItem(key);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const init = stored || (prefersDark ? 'dark' : 'light');
      root.classList.toggle('theme-dark', init === 'dark');
      root.classList.toggle('theme-light', init === 'light');

      const btn = document.getElementById('theme-toggle');
      if (btn) btn.addEventListener('click', () => {
        const isDark = root.classList.toggle('theme-dark');
        root.classList.toggle('theme-light', !isDark);
        localStorage.setItem(key, isDark ? 'dark' : 'light');
      });

      // Lazy load images
      document.querySelectorAll('img:not([loading])').forEach(img => {
        img.setAttribute('loading','lazy'); img.setAttribute('decoding','async');
      });

      // Code blocks
      document.querySelectorAll('div.highlight > pre, pre.highlight').forEach(pre => {
        pre.classList.add('has-copy');
        const code = pre.querySelector('code') || pre;
        const lang = [...(code.classList||[]), ...(pre.classList||[])]
          .map(c => (c.startsWith('language-') ? c.replace('language-','') : null))
          .filter(Boolean)[0];
        if (lang) {
          const label = document.createElement('span');
          label.className = 'code-lang';
          label.textContent = lang;
          pre.appendChild(label);
        }
        const b = document.createElement('button');
        b.className='copy-btn'; b.type='button'; b.textContent='Copy';
        b.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(code.innerText);
            b.textContent='Copied!'; setTimeout(()=>b.textContent='Copy',1200);
          } catch(e){ b.textContent='Oops'; setTimeout(()=>b.textContent='Copy',1200); }
        });
        pre.appendChild(b);
      });

      // Heading anchors
      document.querySelectorAll('.post-content h2, .post-content h3').forEach(h => {
        if (!h.id) {
          h.id = h.textContent.trim().toLowerCase().replace(/[^\w]+/g,'-').replace(/(^-|-$)/g,'');
        }
        const a = document.createElement('a');
        a.href = `#${h.id}`; a.className='anchor'; a.textContent = '#';
        h.appendChild(a);
      });

      // Reading progress bar
      const bar = document.createElement('div');
      Object.assign(bar.style, {
        position:'fixed', top:'0', left:'0', height:'3px', width:'0',
        background:'var(--accent)', zIndex:'60'
      });
      document.body.appendChild(bar);
      const onScroll = () => {
        const h = document.documentElement;
        const max = h.scrollHeight - h.clientHeight;
        const p = Math.max(0, Math.min(1, (h.scrollTop || document.body.scrollTop) / (max || 1)));
        bar.style.width = (p * 100) + '%';
      };
      document.addEventListener('scroll', onScroll, {passive:true}); onScroll();
    })();
    </script>
  </body>
</html>
