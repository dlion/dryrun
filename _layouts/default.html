<!doctype html>
<html lang="{{ page.lang | default: 'en' }}">
<head>
  {% include head.html %}
  {% if site.plausible_domain and site.plausible_domain != "" %}
    <script defer data-domain="{{ site.plausible_domain }}" src="https://plausible.io/js/script.js"></script>
  {% endif %}
</head>
<body>
  {% include header.html %}

  <main class="container">
    {{ content }}
  </main>

  {% include footer.html %}

  <script>
(function () {
  const root = document.documentElement;
  const key = 'theme';
  const stored = localStorage.getItem(key);
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const init = stored || (prefersDark ? 'dark' : 'light');
  root.classList.toggle('theme-dark', init === 'dark');
  root.classList.toggle('theme-light', init === 'light');

  const btn = document.getElementById('theme-toggle');
  if (btn) btn.addEventListener('click', () => {
    const isDark = root.classList.toggle('theme-dark');
    root.classList.toggle('theme-light', !isDark);
    localStorage.setItem(key, isDark ? 'dark' : 'light');
  });

  // Progressive enhancement: images
  document.querySelectorAll('img:not([loading])').forEach(img => {
    img.setAttribute('loading','lazy'); img.setAttribute('decoding','async');
  });

  // Add "Copy" buttons to code blocks
  document.querySelectorAll('pre > code').forEach(code => {
    const pre = code.parentElement; pre.classList.add('has-copy');
    const b = document.createElement('button'); b.className='copy-btn'; b.type='button'; b.textContent='Copy';
    b.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(code.innerText);
        b.textContent='Copied!'; setTimeout(()=>b.textContent='Copy',1200);
      } catch(e){ b.textContent='Oops'; setTimeout(()=>b.textContent='Copy',1200); }
    });
    pre.appendChild(b);
  });

  // Reading progress bar (tiny)
  const bar = document.createElement('div');
  Object.assign(bar.style, {
    position:'fixed', top:'0', left:'0', height:'3px', width:'0',
    background:'var(--accent)', zIndex:'60', boxShadow:'0 0 0 1px rgba(0,0,0,0.03)'
  });
  document.body.appendChild(bar);
  const onScroll = () => {
    const h = document.documentElement;
    const max = h.scrollHeight - h.clientHeight;
    const p = Math.max(0, Math.min(1, (h.scrollTop || document.body.scrollTop) / (max || 1)));
    bar.style.width = (p * 100) + '%';
  };
  document.addEventListener('scroll', onScroll, {passive:true}); onScroll();
})();
</script>
</body>
</html>