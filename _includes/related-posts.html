{% assign max_items = 2 %}
{% assign cards = '' %}
{% assign count = 0 %}
{% assign used = page.url %}

{% if page.tags and page.tags != empty %}
  {% for tag in page.tags %}
    {% assign tagged_posts = site.tags[tag] %}
    {% if tagged_posts %}
      {% for candidate in tagged_posts %}
        {% if candidate.url != page.url %}
          {% unless used contains candidate.url %}
            {% capture card %}
              {% include related-posts_card.html post=candidate slot=count %}
            {% endcapture %}
            {% assign cards = cards | append: card %}
            {% assign used = used | append: '|' | append: candidate.url %}
            {% assign count = count | plus: 1 %}
          {% endunless %}
        {% endif %}
        {% if count == max_items %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if count == max_items %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if count < max_items %}
  {% for candidate in site.posts %}
    {% if candidate.url != page.url %}
      {% unless used contains candidate.url %}
        {% capture card %}
          {% include related-posts_card.html post=candidate slot=count %}
        {% endcapture %}
        {% assign cards = cards | append: card %}
        {% assign used = used | append: '|' | append: candidate.url %}
        {% assign count = count | plus: 1 %}
      {% endunless %}
    {% endif %}
    {% if count == max_items %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if count > 0 %}
<section class="related-split" aria-labelledby="related-heading">
  <h2 id="related-heading" class="visually-hidden">Keep exploring</h2>
  <div class="related-split-grid">
    {{ cards }}
  </div>
</section>
{% endif %}
